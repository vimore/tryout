include classpath("logparsingjob.conf")
morphlines : [
  {
    # Name used to identify a morphline. E.g. used if there are multiple
    # morphlines in a morphline config file
    id : zyxel_dhcp

    # Import all morphline commands in these java packages and their subpackages.
    # Other commands that may be present on the classpath are not visible to this
    # morphline.
    importCommands : [ "org.kitesdk.morphline.**", "com.securityx.model.mef.morphline.**"]

    commands : [
      {
        kvpSpliter  {
          inputFieldName : "zyxelMessage" 
          fieldSep : " "  
          fieldValueSep : "="  
          quoteChar : "\""  
          trim : true, 
        } 
      },
      {

        if {
          conditions : [
            { contains { cat : [DHCP] } }
          ]
          then : 
          [
            { 
              addKeyValuesIfMissing  {
                sourceUserName : "@{user}"
                cefSignatureId : "@{note}"
             }
            },
            {
              translate {
                field : cefSignatureId
                dictionary : {
                   "DHCP Request" : DHCPREQUEST
                   "DHCP ACK" : DHCPACK
                   "DHCP Offer" : DHCPOFFER
                }
                fallback : Unknown # if no fallback is defined and no match is found then the command fails
              }
            },
            {
              ruleset {
                name : "ZyxelDhcp",
                field : "msg",
                sampleUnmatchedTo : "./na",
                nodes : [
                  { 
                    # DHCP Request
                    # Requested 192.168.2.49 from android-5d9a8e930cf598c9(F4:09:D8:A1:41:A5)
                    dictionaryString : """
                      IP \S+
                      HOSTNAME [^\(]+
                      MACADDR [^\(]+
                    """
                    expr : """Requested\s%{IP:sourceAddress}\sfrom\s(?:%{HOSTNAME:sourceHostName})?\(%{MACADDR:sourceMacAddress}\)"""
                    children : []
                  },
                  { 
                    # DHCP Offer
                    # DHCP server offered 192.168.2.49 to android-5d9a8e930cf598c9(F4:09:D8:A1:41:A5)
                    dictionaryString : """
                      IP \S+
                      HOSTNAME [^\(]+
                      MACADDR [^\(]+
                    """
                    expr : """DHCP\sserver\soffered\s%{IP:destinationAddress}\sto\s(?:%{HOSTNAME:destinationNameOrIp})?\(%{MACADDR:destinationMacAddress}\)"""
                    children : []
                  },
                  { 
                    # DHCP Ack
                    # DHCP server assigned 192.168.2.49 to android-5d9a8e930cf598c9(F4:09:D8:A1:41:A5)
                    dictionaryString : """
                      IP \S+
                      HOSTNAME [^\(]+
                      MACADDR [^\(]+
                    """
                    expr : """DHCP\sserver\sassigned\s%{IP:destinationAddress}\sto\s(?:%{HOSTNAME:destinationNameOrIp})?\(%{MACADDR:destinationMacAddress}\)"""
                    children : []
                  }
                ]
              }
            },
            {
              addKeyValuesIfMissing  {
                  logSourceType : "HETMef"
                  externalLogSourceType : "zyxel-dhcp"
                  deviceNameOrIp : "@{logCollectionHost}"
                  startTime: "@{receiptTimeStr}"
              }
            },
            {
              date2timestamp{
                  inputFieldName : "startTime", 
                  dateFormat : ${zyxel_dhcp.date.dateFormat},
                  precision : "ms",
                  timeZone : ${zyxel_dhcp.date.timeZone}, 
                  guessYear : true
              }
            }
          ]
          else : [
            { 
              logInfo { format : "not a dhcp event" }
            }
          ]
        }
        
      }

      
#,
#      {
#        validateSupportedFormat  {
#          failOnUnknownFields : "false"
#          defaultFormat : "HETMef"
#        }
#      }
    ]
  } 
]