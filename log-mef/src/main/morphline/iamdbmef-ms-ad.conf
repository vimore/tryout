include classpath("logparsingjob.conf")
morphlines : [
  { id : msad-csvde_parser
    importCommands : [ "org.kitesdk.morphline.**", "com.securityx.model.mef.morphline.**"]
     commands : [
       { 
                harnessCmd  {
                  morphlineFile : "iamdbmef-ms-ad.conf",
                  morphlineId : "msad-csvde",
                  transferFieldNamedToMessage : "message",
                  messageFieldName : "msadInput"
                }
              }
     ]
  },
  {
    id : msad-csvde
    importCommands : [ "org.kitesdk.morphline.**", "com.securityx.model.mef.morphline.**"]

    commands : [
        {
          if {
            conditions : [
              { isMsADHeader { field="msadInput" } }
            ]
            then : [
              { msADHeaderExtractor { field="msadInput" } }
            ]
            else : [
              { 
                harnessCmd  {
                  morphlineFile : "iamdbmef-ms-ad.conf",
                  morphlineId : "csvdeKVP",
                  transferFieldNamedToMessage : "msadInput",
                  messageFieldName : "msadInput"
                }
              },
              {
                iamDbMefFormat {
                    formatIdFromFieldName : "logSourceType",  
                    discardUnmappableFields : "false", 
                    discardOriginalMappedFields :  "true"
                    }
              },
              {
                  date2timestamp{
                    inputFieldNames : ["creationDate", "lastModificationDate"]
                    #Thu Apr 24 12:43:48 2014
                    dateFormat : "yyyyMMddHHmmss.S'Z'",  
                    precision : "ms",
                    timeZone : "UTC"
                  }
              },
              {
                validateSupportedFormat  {
                  failOnUnknownFields : "false"
                  defaultFormat : "IAMDBMef"
                }
              }
            ]
          }
        },
    ]
  },
  {
    id : csvdeKVP
    importCommands : [ "org.kitesdk.morphline.**", "com.securityx.model.mef.morphline.**"]

    commands : [
      {

        tsvq {
            inputFieldName : "msadInput",
            fieldSep : ",",
            quoteChar : "\"",
            trim : true,
            fieldNames : [
              "DN",
              "objectClass",
              "distinguishedName",
              "instanceType",
              "whenCreated",
              "whenChanged",
              "subRefs",
              "uSNCreated",
              "uSNChanged",
              "name",
              "objectGUID",
              "creationTime",
              "forceLogoff",
              "lockoutDuration",
              "lockOutObservationWindow",
              "lockoutThreshold",
              "maxPwdAge",
              "minPwdAge",
              "minPwdLength",
              "modifiedCountAtLastProm",
              "nextRid",
              "pwdProperties",
              "pwdHistoryLength",
              "objectSid",
              "serverState",
              "uASCompat",
              "modifiedCount",
              "auditingPolicy",
              "nTMixedDomain",
              "rIDManagerReference",
              "fSMORoleOwner",
              "systemFlags",
              "wellKnownObjects",
              "objectCategory",
              "isCriticalSystemObject",
              "gPLink",
              "dSCorePropagationData",
              "otherWellKnownObjects",
              "masteredBy",
              "ms-DS-MachineAccountQuota",
              "msDS-Behavior-Version",
              "msDS-PerUserTrustQuota",
              "msDS-AllUsersTrustQuota",
              "msDS-PerUserTrustTombstonesQuota",
              "msDs-masteredBy",
              "msDS-IsDomainFor",
              "msDS-NcType",
              "dc",
              "cn",
              "description",
              "showInAdvancedViewOnly",
              "ou",
              "msDS-TombstoneQuotaFactor",
              "displayName",
              "flags",
              "versionNumber",
              "gPCFunctionalityVersion",
              "gPCFileSysPath",
              "gPCMachineExtensionNames",
              "ipsecName",
              "ipsecID",
              "ipsecDataType",
              "ipsecData",
              "ipsecISAKMPReference",
              "ipsecNFAReference",
              "ipsecOwnersReference",
              "ipsecNegotiationPolicyReference",
              "ipsecFilterReference",
              "iPSECNegotiationPolicyType",
              "iPSECNegotiationPolicyAction",
              "revision",
              "memberOf",
              "userAccountControl",
              "badPwdCount",
              "codePage",
              "countryCode",
              "badPasswordTime",
              "lastLogoff",
              "lastLogon",
              "logonHours",
              "pwdLastSet",
              "primaryGroupID",
              "adminCount",
              "accountExpires",
              "logonCount",
              "sAMAccountName",
              "sAMAccountType",
              "lastLogonTimestamp",
              "groupType",
              "member",
              "samDomainUpdates",
              "localPolicyFlags",
              "operatingSystem",
              "operatingSystemVersion",
              "operatingSystemServicePack",
              "serverReferenceBL",
              "dNSHostName",
              "rIDSetReferences",
              "servicePrincipalName",
              "msDS-SupportedEncryptionTypes",
              "msDFSR-ComputerReferenceBL",
              "rIDAvailablePool",
              "rIDAllocationPool",
              "rIDPreviousAllocationPool",
              "rIDUsedPool",
              "rIDNextRID",
              "dnsRecord",
              "msDFSR-Flags",
              "msDFSR-ReplicationGroupType",
              "msDFSR-FileFilter",
              "msDFSR-DirectoryFilter",
              "serverReference",
              "msDFSR-ComputerReference",
              "msDFSR-MemberReferenceBL",
              "msDFSR-Version",
              "msDFSR-ReplicationGroupGuid",
              "msDFSR-MemberReference",
              "msDFSR-RootPath",
              "msDFSR-StagingPath",
              "msDFSR-Enabled",
              "msDFSR-Options",
              "msDFSR-ContentSetGuid",
              "msDFSR-ReadOnly",
              "lastSetTime",
              "priorSetTime",
              "givenName",
              "managedObjects",
              "userPrincipalName",
              "sn",
              "lockoutTime",
              "managedBy",
              "directReports",
              "userWorkstations",
              "c",
              "l",
              "st",
              "title",
              "postalCode",
              "postOfficeBox",
              "physicalDeliveryOfficeName",
              "telephoneNumber",
              "facsimileTelephoneNumber",
              "initials",
              "otherTelephone",
              "info",
              "co",
              "department",
              "company",
              "streetAddress",
              "wWWHomePage",
              "homeDirectory",
              "scriptPath",
              "profilePath",
              "ipPhone",
              "mail",
              "manager",
              "homePhone",
              "mobile",
              "pager"
            ]
        }
      },
      {
        discardEmpty{}
      },
      {
        addValuesIfAbsent  {
            logSourceType : "csvde"
            deviceNameOrIp : "@{logCollectionHost}",
            locationStr : "@{streetAddress}\n@{company}\n@{postalCode} @{co}",
            managedBy : "@{manager}"
            #accountName : "@{sAMAccountName}"
            #accountType : "@{description}"
        }
      }
    ]
  }
]
