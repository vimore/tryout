include classpath("logparsingjob.conf")
morphlines : [
  {
    # Name used to identify a morphline. E.g. used if there are multiple
    # morphlines in a morphline config file
    id : sysloglogcollection

    # Import all morphline commands in these java packages and their subpackages.
    # Other commands that may be present on the classpath are not visible to this
    # morphline.
    importCommands : [ "org.kitesdk.morphline.**",  "com.securityx.model.mef.morphline.**"]

    commands : [

      {
        grokcmd {
            # broken by relocation of morphline config to resource
            #dictionaryFiles : [logcollection-grok-patterns] 
            dictionaryString : """
              ####################
              # Syslog severity
              SEV <\d+>
              #DATE TIME
              # Months: January, Feb, 3, 03, 12, December
              MONTH """${syslog.date.month.pattern}"""
              MONTHNUM (?:0?[1-9]|1[0-2])
              MONTHDAY (?:(?:0[1-9])|(?:[12][0-9])|(?:3[01])|[1-9]) 
              # Years?
              YEAR (?>\d\d){1,2}
              # Time: HH:MM:SS
              HOUR (?:2[0123]|[01]?[0-9])
              MINUTE (?:[0-5][0-9])
              # '60' is a leap second in most time standards and thus is valid.
              SECOND (?:(?:[0-5][0-9]|60)(?:[:.,][0-9]+)?)
              TIME (?!<[0-9])%{HOUR}:%{MINUTE}(?::%{SECOND})(?![0-9]) 

              #Syslog date : Aug 15 11:02:57
              SYSLOGDATE %{MONTH}\s+%{MONTHDAY}\s%{TIME}
              
              ####################
              # Hostname and IP
              IP (?<![0-9])(?:(?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]{1,2})[.](?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]{1,2})[.](?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]{1,2})[.](?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]{1,2}))(?![0-9])
              HOSTNAME \b(?:[0-9A-Za-z][0-9A-Za-z-]{0,62})(?:\.(?:[0-9A-Za-z][0-9A-Za-z-]{0,62}))*(\.?|\b)
              HOST %{HOSTNAME}
              IPORHOST (?:%{HOSTNAME}|%{IP})
              
              ##################
              # GENERIC
              DATAGREEDY .*
            """
            #Oct 16 10:49:20 ciscopix %PIX-6-302015: B....
            expressions : {
                message : """(?:%{SEV})?%{SYSLOGDATE:receiptTime}\s%{IPORHOST:deviceNameOrIp}\s%{DATAGREEDY:syslogMessage}"""
            }
          extract : true
          findSubstrings : true
          addEmptyStrings : false 
        }

      },      
      {
        addKeyValuesIfMissing  {
            receiptTimeStr : "@{receiptTime}"
        }
      }
    ]${syslog.sysloglogcollection.forwarder_cleaning}${syslog.sysloglogcollection.timezone_hook}[
      {
        date2timestamp{
            inputFieldName : "receiptTime", 
            dateFormat : "MMM dd HH:mm:ss",  
            precision : "ms",
            timeZone : "UTC",
            guessYear : true
          }
      }
    ]
  }, 
  {
    id : sysloglogcollectionalt

    # Import all morphline commands in these java packages and their subpackages.
    # Other commands that may be present on the classpath are not visible to this
    # morphline.
    importCommands : [ "org.kitesdk.morphline.**", "com.securityx.model.mef.morphline.**"]
    commands : [

      {
        grok {
            dictionaryString : """
                # Syslog severity
                SEV <\d+>
                ALTYEAR  \d{4}
                HOUR (?:2[0123]|[01]?[0-9])
                MINUTE (?:[0-5][0-9])
                # '60' is a leap second in most time standards and thus is valid.
                SECOND (?:(?:[0-5][0-9]|60)(?:[:.,][0-9]+)?)
                TIME (?!<[0-9])%{HOUR}:%{MINUTE}(?::%{SECOND})(?![0-9]) 
                ALTSYSLOGDATE  (?:0?[1-9]|1[0-2])/(?:(?:0[1-9])|(?:[12][0-9])|(?:3[01])|[1-9])/%{ALTYEAR}\s%{TIME}
                IP (?<![0-9])(?:(?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]{1,2})[.](?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]{1,2})[.](?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]{1,2})[.](?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]{1,2}))(?![0-9])
                HOSTNAME \b(?:[0-9A-Za-z][0-9A-Za-z-]{0,62})(?:\.(?:[0-9A-Za-z][0-9A-Za-z-]{0,62}))*(\.?|\b)
                HOST %{HOSTNAME}
                IPORHOST (?:%{HOSTNAME}|%{IP})
                DATAGREEDY .*
            """
            #10/31/2013 23:59:12 10.2.1.1 ....
            # added a :? after device Name Or Ip to match EDT: cisco log samples
            expressions : {
                message : """(?:%{SEV})?%{ALTSYSLOGDATE:receiptTime}\s%{IPORHOST:deviceNameOrIp}:?\s%{DATAGREEDY:syslogMessage}"""
            }
          extract : true
          findSubstrings : false
          addEmptyStrings : false 
        } 
      },
      {
        addKeyValuesIfMissing  {
            receiptTimeStr : "@{receiptTime}"
        }
      },

      {
        date2timestamp{
            inputFieldName : "receiptTime", 
            dateFormat : "MM/dd/yyyy HH:mm:ss",  
            precision : "ms"
            timeZone : "UTC"
          }
      }
    ]
  },
  {
    id : sysloglogcollectioniso

    # Import all morphline commands in these java packages and their subpackages.
    # Other commands that may be present on the classpath are not visible to this
    # morphline.
    importCommands : [ "org.kitesdk.morphline.**", "com.securityx.model.mef.morphline.**"]
    commands : [

      {
        grok {
          dictionaryString : """
                # Syslog severity
                SEV <\d+>
                VERSION \d{1,2}
                ALTYEAR  \d{4}
                HOUR (?:2[0123]|[01]?[0-9])
                MINUTE (?:[0-5][0-9])
                # '60' is a leap second in most time standards and thus is valid.
                SECOND (?:[0-5][0-9]|60)
                TIME (?!<[0-9])%{HOUR}:%{MINUTE}(?::%{SECOND})
                ISOSYSLOGDATE  %{ALTYEAR}-(?:0?[1-9]|1[0-2])-(?:(?:0[1-9])|(?:[12][0-9])|(?:3[01])|[1-9])T%{TIME}
                ISOSYSLOGMSEC [0-9]{1,3}
                ISOSYSLOGTZ [+-](?:%{HOUR}:?%{MINUTE})
                FACILITY (?:local[0-7]|kern|mail|daemon|auth(?:priv)?|syslog|u(?:ser|ucp)|lpr|news|c(?:ron|lock)|ftp|-)
                IP (?<![0-9])(?:(?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]{1,2})[.](?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]{1,2})[.](?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]{1,2})[.](?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]{1,2}))(?![0-9])
                HOSTNAME \b(?:[0-9A-Za-z][0-9A-Za-z-]{0,62})(?:\.(?:[0-9A-Za-z][0-9A-Za-z-]{0,62}))*(\.?|\b)
                HOST %{HOSTNAME}
                IPORHOST (?:%{HOSTNAME}|%{IP})
                DATAGREEDY .*
            """
          #10/31/2013 23:59:12 10.2.1.1 ....
          # added a :? after device Name Or Ip to match EDT: cisco log samples
          expressions : {
            message : """(?:%{SEV})?(?:%{VERSION}\s)?%{ISOSYSLOGDATE:isoSyslogDate}(:?[.,]%{ISOSYSLOGMSEC:isoSyslogMs}\d*)?(?:%{ISOSYSLOGTZ:isoSyslogTZ})\s(?:%{FACILITY}\s)?%{IPORHOST:deviceNameOrIp}:?\s%{DATAGREEDY:syslogMessage}"""
          }
          extract : true
          findSubstrings : false
          addEmptyStrings : false
        }
      },
      {
        addKeyValuesIfMissing  {
          isoSyslogMs: "0",
          isoSyslogTZ: ${syslog.sysloglogcollection.default_tz},
        }
      },
      {
        addKeyValuesIfMissing  {
          receiptTime: "@{isoSyslogDate}.@{isoSyslogMs}@{isoSyslogTZ}",
          receiptTimeStr: "@{receiptTime}"
        }
      },

      {
        date2timestamp{
          inputFieldName : "receiptTime",
          dateFormat : "yyyy-MM-dd'T'HH:mm:ss.SSSX",
          precision : "ms"
          timeZone : "UTC"
        }
      }
    ]
  }
]