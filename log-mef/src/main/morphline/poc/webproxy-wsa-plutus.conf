include classpath("logparsingjob.conf")
morphlines : [
  {
    # Name used to identify a morphline. E.g. used if there are multiple
    # morphlines in a morphline config file
    id : wsadefault-plutus

    # Import all morphline commands in these java packages and their subpackages.
    # Other commands that may be present on the classpath are not visible to this
    # morphline.
    # Extra fields: server_ip, dest_port, request_size, request_referer, "user agent in quotes"
    
    importCommands : [ "org.kitesdk.**", "org.apache.solr.**", "com.securityx.**"]

    commands : [
#     { logInfo { format : "PLUTUS: wsadefault record: {}", args : ["@{}"] } }
      {
        grokcmd {
#<38>Sep 26 12:30:00 10.44.90.25 <14>Sep 26 12:29:52 ACCESS_LOGS: Info: 1474918191.900 47 10.40.5.12 TCP_MISS/200 302 GET http://svc103.viewfinity.com/VFWIU/wiu.ashx?a=4ec9de79-4951-4134-a043-4386a673efac&s=0bf984e9-7894-4e7c-916d-b690b50a2de3&c=1496966054 - DIRECT/svc103.viewfinity.com text/html DEFAULT_CASE_12-DefaultGroup-DefaultGroup-DefaultGroup-NONE-NONE-DefaultGroup <IW_comp,0.0,0,\"-\",0,0,0,1,\"-\",-,-,-,\"-\",1,-,\"-\",\"-\",-,-,IW_comp,-,\"Unknown\",\"-\",\"Unknown\",\"Unknown\",\"-\",\"-\",51.40,0,Local,\"Unknown\",\"-\",-,\"-\",-,-,\"-\",\"-\"> - 198.11.230.98 80 257 - \"VfAgent 4.5.44.498\"
            dictionaryString : """
              WSAHEADER .*ACCESS_LOGS:\s+(Alert|Warning|Info|Debug):
              UTCSEC \d+
              UTCMS \d{3}
              DURATION \d+
              ####################
              # Hostname and IP
              IP (?<![0-9])(?:(?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]{1,2})[.](?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]{1,2})[.](?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]{1,2})[.](?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]{1,2}))(?![0-9])
              HOSTNAME \b(?:[0-9A-Za-z][0-9A-Za-z-]{0,62})(?:\.(?:[0-9A-Za-z][0-9A-Za-z-]{0,62}))*(\.?|\b)
              HOST %{HOSTNAME}
              IPORHOST (?:%{HOSTNAME}|%{IP})
              CODE [^\/]+
              STATUS \d+
              BYTES \d+
              METHOD \w+
              SCHEME [^:]+
              PORT \d+
              PATH [^\s]+
              NOQUOTEPATH [^\s"]+
              RFC931 [^\s]+
              PEERSTATUS [^\/]+
              PEERHOST %{IP}
              RESPONSECONTENTTYPE  ([a-zA-Z_0-9\-]*/[a-zA-Z_0-9\-\.\+\:\=\?]*|-)
              ACLDECISIONTAG (\w|\-)+
              PREDEVICEEVENTCATEGORY \<
              POSTDEVICEEVENTCATEGORY ,.*\> 
              DEVICEEVENTCATEGORY IW_[a-zA-Z]{1,4}|nc
# nc (uncategorized) or c_ (for sawmill)
              REFERER (((?:%{SCHEME}://)?%{IPORHOST}(?::%{PORT})?(?:%{NOQUOTEPATH})?)|-)
#              USERAGENT ("[^"-]+"|-)
#              USERAGENT ("[^"]+"|-)
              USERAGENT ([^"]+|-)
              SUSPECTUSERAGENT ("[^"]+"|-)
              TRAILER .*              
            """
            expressions : {
             wsaMessage : """%{WSAHEADER:wsaHeader}\s+%{UTCSEC:utcsec}\.%{UTCMS:utcms}\s+%{DURATION}\s%{IPORHOST:sourceNameOrIp}\s%{CODE:devicePolicyAction}/%{STATUS:cefSignatureId}\s%{BYTES:bytesIn}\s%{METHOD:requestMethod}\s(?:%{SCHEME:requestScheme}://)?%{IPORHOST:destinationNameOrIp}(?::%{PORT})?(?:%{PATH:requestPath})?\s%{RFC931:sourceUserName}\s%{PEERSTATUS:deviceAction}/(?:-|%{PEERHOST}|[^\s]+)\s%{RESPONSECONTENTTYPE:responseContentType}\s+%{ACLDECISIONTAG}\s+%{PREDEVICEEVENTCATEGORY}%{DEVICEEVENTCATEGORY:deviceEventCategory}%{POSTDEVICEEVENTCATEGORY}\s+%{SUSPECTUSERAGENT}\s+(%{IP:destinationAddress}|-)\s+(%{PORT:destinationPort}|-)\s+(%{BYTES:bytesOut}|-)\s+(\"?)%{REFERER:requestReferer}(\"?)\s+(\"?)%{USERAGENT:requestClientApplication}(\"?)"""
                
            }
          extract : true
          findSubstrings : false
          addEmptyStrings : false 
        }

      },
      {
        fieldAggregator{
          startTime : ["%{utcsec}%{utcms}"],
        }
      },
      {
        addKeyValuesIfMissing  {
            logSourceType : "WebProxyMef"
            externalLogSourceType : "Cisco_WSA"
            deviceNameOrIp : "@{logCollectionHost}"
        }
      },
      {
        validateSupportedFormat  {
          failOnUnknownFields : "false"
          defaultFormat : "WebProxyMef"
        }
      }
    ]
  },
  {
    # from syslog handling process name before processing line
    id : fromwsaprocess
    importCommands : [ "org.kitesdk.**", "com.securityx.**"]

    commands : [
      { logTrace { format : "wsaprocess record: {}", args : ["@{}"] } }
      
      {
        grokcmd {
            dictionaryString : """
#            WSA \(wsa\):
#             WSA <38>Sep  8 13:23:46 10.44.90.25
             WSA ^<\d{1,3}?>[a-zA-Z]{3}?\s+\d{1,2}?\s+13:23:46\s+10.44.90.25
            GREEDY .*
          """, 
 
            #<38>Sep  8 13:23:46 10.44.90.25 <14>Sep 08 13:23:38 ACCESS_LOGS: Info: 1473366217.541 1300 10.40.5.210 TCP_CLIENT_REFRESH_MISS/200 1040 POST http://intelliconnect.cch.com/scion/secure/ctx_4260093/treeModelService.rpc - DIRECT/intelliconnect.cch.com text/plain DEFAULT_CASE_12-DefaultGroup-DefaultGroup-DefaultGroup-NONE-NONE-DefaultGroup <IW_busi,3.9,0,\"-\",0,0,0,1,\"-\",-,-,-,\"-\",1,-,\"-\",\"-\",-,-,IW_busi,-,\"Unknown\",\"-\",\"Unknown\",\"Unknown\",\"-\",\"-\",6.40,0,Local,\"Unknown\",\"-\",-,\"-\",-,-,\"-\",\"-\"> -

            expressions : {
                wsaInput : """%{WSA}\s+%{GREEDY:wsaMessage}$"""
            }
          extract : true,
          findSubstrings : false,
          addEmptyStrings : false 
        },
      },        
    ]
  }, 
  {
    # from syslog handling process name before processing line
    id : wsafromrsyslog
    importCommands : [ "org.kitesdk.**", "com.securityx.**"]

    commands : [
      { 
        harnessCmd  {
          morphlineFile : "webproxy-wsa-plutus.conf"
          morphlineId : "fromwsaprocess"
          transferFieldNamedToMessage : "message"
          messageFieldName : "wsaInput"
        }
      },
      { 
        harnessCmd  {
          morphlineFile : "webproxy-wsa-plutus.conf"
          morphlineId : "wsadefault-plutus"
          transferFieldNamedToMessage : "wsaMessage"
          messageFieldName : "wsaMessage"
        }
      }
    ]
  },
    { 
    # from file no prefix to handle
    id : wsafromaccesslog
    importCommands : [ "org.kitesdk.**", "com.securityx.**"]

    commands : [
      {
        addValuesIfAbsent  {
            wsaMessage : "@{message}"
        }
      },
      { 
        harnessCmd  {
          morphlineFile : "webproxy-wsa-plutus.conf"
          morphlineId : "wsadefault-plutus"
          transferFieldNamedToMessage : "wsaMessage"
          messageFieldName : "wsaMessage"
        }
      }
    ]
  } 
]
