include classpath("logparsingjob.conf")
morphlines : [
  {
    # Name used to identify a morphline. E.g. used if there are multiple
    # morphlines in a morphline config file
    id : wsadefault

    # Import all morphline commands in these java packages and their subpackages.
    # Other commands that may be present on the classpath are not visible to this
    # morphline.
    importCommands : [ "org.kitesdk.**", "org.apache.solr.**", "com.securityx.**"]

    commands : [
     { logTrace { format : "wsadefault record: {}", args : ["@{}"] } }
      {
        grokcmd {
#<38>Sep  8 13:23:46 10.44.90.25 <14>Sep 08 13:23:38 ACCESS_LOGS: Info: 1473366217.541 1300 10.40.5.210 TCP_CLIENT_REFRESH_MISS/200 1040 POST http://intelliconnect.cch.com/scion/secure/ctx_4260093/treeModelService.rpc - DIRECT/intelliconnect.cch.com text/plain DEFAULT_CASE_12-DefaultGroup-DefaultGroup-DefaultGroup-NONE-NONE-DefaultGroup <IW_busi,3.9,0,\"-\",0,0,0,1,\"-\",-,-,-,\"-\",1,-,\"-\",\"-\",-,-,IW_busi,-,\"Unknown\",\"-\",\"Unknown\",\"Unknown\",\"-\",\"-\",6.40,0,Local,\"Unknown\",\"-\",-,\"-\",-,-,\"-\",\"-\"> -

            dictionaryString : """
              WSAHEADER .*ACCESS_LOGS:\s+(Alert|Warning|Info|Debug):
              UTCSEC \d+
              UTCMS \d{3}
              DURATION \d+
              ####################
              # Hostname and IP
              IP (?<![0-9])(?:(?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]{1,2})[.](?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]{1,2})[.](?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]{1,2})[.](?:25[0-5]|2[0-4][0-9]|[0-1]?[0-9]{1,2}))(?![0-9])
              HOSTNAME \b(?:[0-9A-Za-z][0-9A-Za-z-]{0,62})(?:\.(?:[0-9A-Za-z][0-9A-Za-z-]{0,62}))*(\.?|\b)
              HOST %{HOSTNAME}
              IPORHOST (?:%{HOSTNAME}|%{IP})
              CODE [^\/]+
              STATUS \d+
              BYTES \d+
              METHOD \w+
              SCHEME [^:]+
              PORT \d+
              PATH [^\s]+
              RFC931 [^\s]+
              PEERSTATUS [^\/]+
              PEERHOST %{IP}
              RESPONSECONTENTTYPE  [a-zA-Z_0-9\-]*/[a-zA-Z_0-9\-\.\+\:\=\?]*|\-
              ACLDECISIONTAG (\w|\-)+
              PREDEVICEEVENTCATEGORY \<
              POSTDEVICEEVENTCATEGORY ,.*\> 
              DEVICEEVENTCATEGORY IW_[a-zA-Z]{1,4}|nc
# nc (uncategorized) or c_ (for sawmill)
              SUSPECTUSERAGENT .*              
              
            """
            #<38>Sep  8 13:23:47 10.44.90.25 <14>Sep 08 13:23:38 ACCESS_LOGS: Info: 1473366218.253 146 10.40.81.66 TCP_MISS/200 493 POST http://events.workshare.com/track - DIRECT/events.workshare.com application/octet-stream DEFAULT_CASE_12-DefaultGroup-DefaultGroup-DefaultGroup-NONE-NONE-DefaultGroup <IW_busi,1.5,0,\"-\",0,0,0,1,\"-\",-,-,-,\"-\",0,0,\"-\",\"-\",-,-,IW_busi,-,\"Unknown\",\"-\",\"Unknown\",\"Unknown\",\"-\",\"-\",27.01,0,Local,\"Unknown\",\"-\",-,\"-\",-,-,\"-\",\"-\"> -            
            expressions : {
                wsaMessage : """%{WSAHEADER:wsaHeader}\s+%{UTCSEC:utcsec}\.%{UTCMS:utcms}\s+%{DURATION}\s%{IPORHOST:sourceNameOrIp}\s%{CODE:devicePolicyAction}/%{STATUS:cefSignatureId}\s%{BYTES:bytesIn}\s%{METHOD:requestMethod}\s(?:%{SCHEME:requestScheme}://)?%{IPORHOST:destinationNameOrIp}(?::%{PORT:destinationPort})?(?:%{PATH:requestPath})?\s%{RFC931:sourceUserName}\s%{PEERSTATUS:deviceAction}/(?:-|%{PEERHOST:destinationAddress}|[^\s]+)\s%{RESPONSECONTENTTYPE:responseContentType}\s+%{ACLDECISIONTAG}\s+%{PREDEVICEEVENTCATEGORY}%{DEVICEEVENTCATEGORY:deviceEventCategory}%{POSTDEVICEEVENTCATEGORY}\s+%{SUSPECTUSERAGENT:requestClientApplication}"""
            }
          extract : true
          findSubstrings : false
          addEmptyStrings : false 
        }

      },
      {
        fieldAggregator{
          startTime : ["%{utcsec}%{utcms}"],
        }
      },
      {
        addKeyValuesIfMissing  {
            logSourceType : "WebProxyMef"
            externalLogSourceType : "Cisco_WSA"
            deviceNameOrIp : "@{logCollectionHost}"
        }
      },
      {
        validateSupportedFormat  {
          failOnUnknownFields : "false"
          defaultFormat : "WebProxyMef"
        }
      }
    ]
  },
  {
    # from syslog handling process name before processing line
    id : fromwsaprocess
    importCommands : [ "org.kitesdk.**", "com.securityx.**"]

    commands : [
      { logTrace { format : "wsaprocess record: {}", args : ["@{}"] } }
      
      {
        grokcmd {
            dictionaryString : """
#            WSA \(wsa\):
#             WSA <38>Sep  8 13:23:46 10.44.90.25
             WSA ^<\d{1,3}?>[a-zA-Z]{3}?\s+\d{1,2}?\s+13:23:46\s+10.44.90.25
            GREEDY .*
          """, 
 
            #<38>Sep  8 13:23:46 10.44.90.25 <14>Sep 08 13:23:38 ACCESS_LOGS: Info: 1473366217.541 1300 10.40.5.210 TCP_CLIENT_REFRESH_MISS/200 1040 POST http://intelliconnect.cch.com/scion/secure/ctx_4260093/treeModelService.rpc - DIRECT/intelliconnect.cch.com text/plain DEFAULT_CASE_12-DefaultGroup-DefaultGroup-DefaultGroup-NONE-NONE-DefaultGroup <IW_busi,3.9,0,\"-\",0,0,0,1,\"-\",-,-,-,\"-\",1,-,\"-\",\"-\",-,-,IW_busi,-,\"Unknown\",\"-\",\"Unknown\",\"Unknown\",\"-\",\"-\",6.40,0,Local,\"Unknown\",\"-\",-,\"-\",-,-,\"-\",\"-\"> -

            expressions : {
                wsaInput : """%{WSA}\s+%{GREEDY:wsaMessage}$"""
            }
          extract : true,
          findSubstrings : false,
          addEmptyStrings : false 
        },
      },        
    ]
  }, 
  {
    # from syslog handling process name before processing line
    id : wsafromrsyslog
    importCommands : [ "org.kitesdk.**", "com.securityx.**"]

    commands : [
      { 
        harnessCmd  {
          morphlineFile : "webproxy-wsa.conf"
          morphlineId : "fromwsaprocess"
          transferFieldNamedToMessage : "message"
          messageFieldName : "wsaInput"
        }
      },
      { 
        harnessCmd  {
          morphlineFile : "webproxy-wsa.conf"
          morphlineId : "wsadefault"
          transferFieldNamedToMessage : "wsaMessage"
          messageFieldName : "wsaMessage"
        }
      }
    ]
  },
    { 
    # from file no prefix to handle
    id : wsafromaccesslog
    importCommands : [ "org.kitesdk.**", "com.securityx.**"]

    commands : [
      {
        addValuesIfAbsent  {
            wsaMessage : "@{message}"
        }
      },
      { 
        harnessCmd  {
          morphlineFile : "webproxy-wsa.conf"
          morphlineId : "wsadefault"
          transferFieldNamedToMessage : "wsaMessage"
          messageFieldName : "wsaMessage"
        }
      }
    ]
  } 
]
